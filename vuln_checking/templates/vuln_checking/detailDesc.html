{% extends "collectionmanagement/base.html" %}
{%load static%}
{%block content%}
<style>
    .table td, .table select, .table input{
            background-color: inherit;
            border: none;
        }
</style>
<p class="h3">Detailed result of scan <small class="text-muted">{{scan_name}}</small> on endpoint : <small class="text-muted">{{endpoint}}</small></p>
<form method="post">
    {%csrf_token%}
<input type="text" hidden value="{{scan_name}}" name="scan_name" id="scan_name">
<input type="text" hidden value="{{endpoint}}" name="endpoint_name" id="endpoint_name">
<div class="container mt-3 mb-3">
   
  <table class="table-borderless table table-light"> 
      <tr>
        <td>Choose a security checkpoint</td>
        <td>
            <select id="my_select" class="form-select  ml-4" aria-label="Default select example" name="checkpoint">
                <option value="0" selected>Select Checkpoint</option>
                {%for checkpoint in checkpoints%}
                   <option value="{{checkpoint.id}}">{{checkpoint.Name}}</option>
                {%endfor%}
            </select>
        </td>
      </tr>

      <tr>
         <td>Status</td>
         <td>
            <select class="form-select ml-4" aria-label="Default select example" style="width:max-content;" id="conditionSelect" name="status">
                <option value="YES">YES</option>
                <option value="NO">NO</option>
                <option value="NOT">NOT</option>
            </select>
         </td>
       </tr>
  </table>

</div>

<div class="container mt-4" id="conditionalTable">
    <table class="table table-secondary">
        <thead class="table-light text-center">
            <tr>
                <th>Vulnerability</th>
                <th>Owasp Risk Score</th>
                <th>Confidentiality Impact</th>
                <th>Integrity Impact</th>
                <th>Availability Impact</th>
                <th>Risk score</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><textarea id="vuln" style="word-wrap:break-word;white-space:pre-wrap;background-color: inherit;border:none;"></textarea>
                <td><input type="text" readonly value="" class="text-center w-100" id="owaspRisk"></td>
                <td>
                    <input type="text" id="C_impact" value="" class="text-center w-100" name="C_impact">
                </td>
                <td>
                    <input type="text" id="I_impact" value="" class="text-center w-100" name="I_impact">
                </td>
                <td>
                    <input type="text" id="A_impact" value="" class="text-center w-100" name="A_impact">
                </td>
                <td>
                    <input type="text" id="Risk_Score" value="" class="text-center w-100" readonly>
                </td>
            </tr>
        </tbody>
    </table>
</div>


    <div class="overflow-auto mt-3" style="height:650px;">
        
        <div class="container">
            <div class="row form-floating">
                 <div class="col-md-2">
                    <select class="nav-link form-select mb-1" name="bMethod" id="bMethod" disabled>
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                     </select>
                 </div>
                 <div class="col-md-8">
                    <input type="text" width="100%" class="form-control" style="color: black;" placeholder="Enter an URL" value="" name="bURL" id="bURL" readonly>
                 </div>
            </div>
            <div class="row">
                <div class="card stretch-card col-md-6">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Base Request Header</h4> 
                            <div class="form-floating">
                                <textarea id="bHeader" name="bheader" style="height: 150px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10" readonly></textarea>
                            </div>
                    </div> 
                </div>

                <div class="card stretch-card col-md-6">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Base Request Body</h4> 
                            <div class="form-floating">
                                <textarea id="bBody" name="bBody" style="height: 150px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10" readonly></textarea>
                            </div>
                    </div>
                </div>
            </div>

            <div class="row card stretch-card">
                <div class="card-body">
                    <h4 class="card-title mb-1">Base Request Response</h4> 
                        <div class="form-floating">
                        <textarea id="bResponse" name="bResponse" style="height:200px;width:100%;box-sizing: border-box;text-align: left;" 
                        rows="10" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-3">
            <div class="row form-floating">
                <div class="col-md-2">
                    <select class="nav-link form-select mb-1" name="mMethod" id="mMethod">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                     </select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control p-2" style="color: black;" placeholder="Enter an URL" value="" name="mURL" id="mURL">
                </div>

                <div class="col-md-2 mb-2">
                    <button  class="nav-link form-select btn btn-secondary" id="send" type="submit">Send Request</button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 card stretch-card">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Modified Request Header</h4> 
                           <div class="form-floating">
                            <textarea id="mHeader" name="mheader" style="height: 150px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10"></textarea>
                            </div>
                    </div>
                </div>

                <div class="col-md-6 card stretch-card">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Modified Request Body</h4> 
                            <div class="form-floating">
                                <textarea id="mBody" name="mBody" style="height: 150px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10"></textarea>
                            </div>
                    </div>
                </div>
            </div>

            <div class="row card stretch-card">
                <div class="card-body">
                    <h4 class="card-title mb-1">Modified Request Response</h4> 
                        <div class="form-floating">
                        <textarea id="modifiedResponse" name="body" style="height: 200px;width:100%;box-sizing: border-box;text-align: left;" 
                        rows="10" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-2 row">
        <button class="btn btn-primary" type="submit" name="action" style="width:100px;height:35px;" value="Save">Save</button>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var choosedCheckpoint = {{ choosedCheckpoint|safe }};
        $(document).ready(function() {
            var owaspRiskScore;
            $('#my_select').change(function() {
                var selectedValue = $(this).val();
                console.log(selectedValue);
                var endpoint = '{{endpoint.id}}';
                var scan_name = '{{scan_name}}'
                if (selectedValue) {
                    $.ajax({
                        url: "{% url 'get_values' %}",
                        data: {
                            'checkpoint': selectedValue,
                            'endpoint': endpoint,
                            'scan':scan_name,
                        },
                        dataType: 'json',
                        success: function(data) {
                            $('#bHeader').val(data.baseHeader)
                            $('#bBody').val(data.baseBody)
                            $('#bURL').val(data.baseURL)
                            $('#bMethod').val(data.baseMethod)
                            $('#conditionSelect').val(data.status)
                            $('#owaspRisk').val(data.owaspRiskScore)
                            $('#vuln').val(data.vuln)
                            //$('#bResponse').val(data.)
                            $('#mHeader').val(data.mHeader)
                            $('#mBody').val(data.mBody)
                            $('#mURL').val(data.mURL)
                            $('#mMethod').val(data.mMethod)
                            $('#modifiedResponse').val(data.modifiedResponse);
                            $('#bResponse').val(data.baseResponse);
                            //$('#modifiedRequest').val(data.modifiedRequest);
                            //$('#baseRequest').val(data.baseRequest);
                            //$('#conditionSelect').val(data.status);
                            owaspRiskScore=data.owaspRiskScore;
                            //alert($('#conditionSelect').val());
                            if($('#conditionSelect').val()=='YES' || $('#conditionSelect').val()=='NOT'){
                                $('#conditionalTable').hide();
                                $('#C_impact').val(0);
                                $('#I_impact').val(0);
                                $('#A_impact').val(0);
                                $('#Risk_Score').val(0);
                            }
                            else if($('#conditionSelect').val()=='NO'){
                                $('#conditionalTable').show();
                                $('#C_impact').val(data.impactConfidentiality);
                                $('#I_impact').val(data.impactIntegrity);
                                $('#A_impact').val(data.impactAvailability);
                                $('#Risk_Score').val(data.impactScore);
                            }
                        },
                        error: function() {
                            $('#textarea-element-1').val('');
                            $('#textarea-element-2').val('');
                        }
                    });
                } else {
                    $('#textarea-element-1').val('');
                    $('#textarea-element-2').val('');
                }
            });
            
           $('#send').click(function(event){
              event.preventDefault();
              console.log('we are in');
              $.ajax({
                type:'POST',
                url:"{% url 'send_request' %}",
                data:{
                   'mURL':$('#mURL').val(),
                   'mBody':$('#mBody').val(),
                   'mheader':$('#mHeader').val(),
                   'mMethod':$('#mMethod').val(),
                   'scan_name':$('#scan_name').val(),
                   'endpoint_name':$('#endpoint_name').val(),
                   'checkpoint':$('#my_select').val(),
                   'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                dataType:'json',
                success:function(data){
                    $('#mHeader').val(data.mHeader)
                    $('#mBody').val(data.mBody)
                    $('#mURL').val(data.mURL)
                    $('#mMethod').val(data.mMethod)
                    $('#modifiedResponse').val(data.modifiedResponse);  
                },
                error:function(){
                    console.log('error')
                }
              })
           });

            $('#conditionSelect').change(function(){
                var status = $('#conditionSelect').val();
                if($('#conditionSelect').val()=='YES' || $('#conditionSelect').val()=='NOT'){
                     $('#conditionalTable').hide();
                }
                else if($('#conditionSelect').val()=='NO'){
                    $('#conditionalTable').show();
                    $('#C_impact').val(data.impactConfidentiality);
                    $('#I_impact').val(data.impactIntegrity);
                    $('#A_impact').val(data.impactAvailability);
                    $('#Risk_Score').val(data.impactScore);

                }
            })

            $('#C_impact,#I_impact,#A_impact').change(function(){
                var cImpact = parseInt($('#C_impact').val(), 10) || 0;
                var iImpact = parseInt($('#I_impact').val(), 10) || 0;
                var aImpact = parseInt($('#A_impact').val(), 10) || 0;
                var total = owaspRiskScore * (cImpact + iImpact + aImpact);
                $('#Risk_Score').val(total);
            });
        });
    </script>
<!--<script>
    document.addEventListener("DOMContentLoaded", function() {
    var choosedCheckpoint = {{ choosedCheckpoint|safe }};  // Assurez-vous que cette variable est rendue correctement
    console.log(choosedCheckpoint);
    var selectElement = document.getElementById('my_select');

    for (var i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].value == choosedCheckpoint) {
            selectElement.selectedIndex = i;
            var event = new Event('change');
            selectElement.dispatchEvent(event);
            break;
        }
    }
});
</script>-->
{%endblock%}