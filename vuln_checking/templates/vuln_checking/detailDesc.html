{% extends "collectionmanagement/base.html" %}
{%load static%}
{%block content%}
<style>
    .table td, .table select, .table input{
            background-color: inherit;
            border: none;
        }
</style>
<p class="h3">Detailed result of scan <small class="text-muted">{{scan_name}}</small> on endpoint : <small class="text-muted">{{endpoint}}</small></p>
<form method="post">
    {%csrf_token%}
<div class="container mt-3 mb-3">
   
  <table class="table-borderless table table-light"> 
      <tr>
        <td>Choose a security checkpoint</td>
        <td>
            <select id="my_select" class="form-select  ml-4" aria-label="Default select example">
                <option selected>Select Checkpoint</option>
                {%for checkpoint in checkpoints%}
                   <option value="{{checkpoint.id}}">{{checkpoint.Name}}</option>
                {%endfor%}
            </select>
        </td>
      </tr>

      <tr>
         <td>Status</td>
         <td>
            <select class="form-select ml-4" aria-label="Default select example" style="width:max-content;" id="conditionSelect">
                <option>YES</option>
                <option>NO</option>
                <option selected>NOT</option>
            </select>
         </td>
       </tr>
  </table>

</div>

<div class="container mt-4" id="conditionalTable">
    <table class="table table-secondary">
        <thead class="table-light text-center">
            <tr>
                <th>Confidentiality Impact</th>
                <th>Integrity Impact</th>
                <th>Availability Impact</th>
                <th>Risk score</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input type="text" id="C_impact" value="" class="text-center w-100">
                </td>
                <td>
                    <input type="text" id="I_impact" value="" class="text-center w-100">
                </td>
                <td>
                    <input type="text" id="A_impact" value="" class="text-center w-100">
                </td>
                <td>
                    <input type="text" id="Risk_Score" value="" class="text-center w-100" readonly>
                </td>
            </tr>
        </tbody>
    </table>
</div>


    <div class="overflow-auto mt-3" style="height: 500px;">
        
        <div class="row">
            <div class="col-md-6">
                <div class="card stretch-card row">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Base Request Header</h4> 
                            <div class="form-floating">
                                <select class="nav-link form-select mb-1" name="bMethod" id="bMethod" disabled>
                                    <option>GET</option>
                                    <option>POST</option>
                                    <option>PUT</option>
                                    <option>DELETE</option>
                                 </select>
                                 <input type="text" class="form-control mb-1" style="color: black;" placeholder="Enter an URL" value="" name="bURL" id="bURL" readonly>
                                <textarea id="bHeader" name="bheader" style="height: 250px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10" readonly></textarea>
                            </div>
                    </div>
                </div>
                
                <div class="card stretch-card row">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Base Request Body</h4> 
                            <div class="form-floating">
                                <textarea id="bBody" name="bBody" style="height: 250px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10" readonly></textarea>
                            </div>
                    </div>
                </div>
                
            </div>
            
            <div class="col-md-6  card stretch-card">
            <div class="card-body">
                <h4 class="card-title mb-1">Base Request Response</h4> 
                    <div class="form-floating">
                    <textarea id="bResponse" name="bResponse" style="height: 400px;width:100%;box-sizing: border-box;text-align: left;" 
                    rows="10" readonly></textarea>
                </div>
            </div>
            </div>
        
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card stretch-card row">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Modified Request Header</h4> 
                           <div class="form-floating">
                             <select class="nav-link form-select mb-1" name="mMethod" id="mMethod">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                             </select>
                             <input type="text" class="form-control mb-1" style="color: black;" placeholder="Enter an URL" value="" name="mURL" id="mURL" readonly>
                            <textarea id="mHeader" name="mheader" style="height: 250px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10"></textarea>
                            </div>
                    </div>
                </div>
                
                <div class="card stretch-card row">
                    <div class="card-body">
                        <h4 class="card-title mb-1">Modified Request Body</h4> 
                            <div class="form-floating">
                                <textarea id="mBody" name="mBody" style="height: 250px;width:100%;box-sizing: border-box;text-align: left;" 
                            rows="10"></textarea>
                            </div>
                    </div>
                </div>
                
            </div>
            
            <div class="col-md-6  card stretch-card">
            <div class="card-body">
                <h4 class="card-title mb-1">Modified Request Response</h4> 
                    <div class="form-floating">
                    <textarea id="modifiedResponse" name="body" style="height: 400px;width:100%;box-sizing: border-box;text-align: left;" 
                    rows="10" readonly></textarea>
                </div>
            </div>
            </div>
        
        </div>

        <div class="row mt-2 ml-4 mb-3">
            <input class="nav-link  badge-warning create-new-button mt-3 mt-md" type="submit" value="Send Request" name="sendRequest">
        </div>
    </div>

    <div class="container mt-2 row">
        <button class="btn btn-primary" type="submit" style="width:100px;height:35px;" name="save">Save</button>
    </div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var owaspRiskScore;
            $('#my_select').change(function() {
                var selectedValue = $(this).val();
                var endpoint = '{{endpoint.id}}';
                var scan_name = '{{scan_name}}'
                if (selectedValue) {
                    $.ajax({
                        url: "{% url 'get_values' %}",
                        data: {
                            'checkpoint': selectedValue,
                            'endpoint': endpoint,
                            'scan':scan_name,
                        },
                        dataType: 'json',
                        success: function(data) {
                            $('#bHeader').val(data.baseHeader)
                            $('#bBody').val(data.baseBody)
                            $('#bURL').val(data.baseURL)
                            $('#bMethod').val(data.baseMethod)
                            //$('#bResponse').val(data.)
                            $('#mHeader').val(data.mHeader)
                            $('#mBody').val(data.mBody)
                            $('#mURL').val(data.mURL)
                            $('#mMethod').val(data.mMethod)
                            //$('#modifiedResponse').val(data.modifiedResponse);
                            //$('#modifiedRequest').val(data.modifiedRequest);
                            //$('#baseRequest').val(data.baseRequest);
                            //$('#baseResponse').val(data.baseResponse);
                            //$('#conditionSelect').val(data.status);
                            owaspRiskScore=data.owaspRiskScore;
                            //alert($('#conditionSelect').val());
                            if($('#conditionSelect').val()=='YES' || $('#conditionSelect').val()=='NOT'){
                                $('#conditionalTable').hide();
                                $('#C_impact').val(0);
                                $('#I_impact').val(0);
                                $('#A_impact').val(0);
                                $('#Risk_Score').val(0);
                            }
                            else if($('#conditionSelect').val()=='NO'){
                                $('#conditionalTable').show();
                                $('#C_impact').val(data.impactConfidentiality);
                                $('#I_impact').val(data.impactIntegrity);
                                $('#A_impact').val(data.impactAvailability);
                                $('#Risk_Score').val(data.impactScore);
                            }
                        },
                        error: function() {
                            $('#textarea-element-1').val('');
                            $('#textarea-element-2').val('');
                        }
                    });
                } else {
                    $('#textarea-element-1').val('');
                    $('#textarea-element-2').val('');
                }
            });

            $('#conditionSelect').change(function(){
                var status = $('#conditionSelect').val();
                if($('#conditionSelect').val()=='YES' || $('#conditionSelect').val()=='NOT'){
                     $('#conditionalTable').hide();
                }
                else if($('#conditionSelect').val()=='NO'){
                    $('#conditionalTable').show();
                    $('#C_impact').val(data.impactConfidentiality);
                    $('#I_impact').val(data.impactIntegrity);
                    $('#A_impact').val(data.impactAvailability);
                    $('#Risk_Score').val(data.impactScore);

                }
            })

            $('#C_impact,#I_impact,#A_impact').change(function(){
                var cImpact = parseInt($('#C_impact').val(), 10) || 0;
                var iImpact = parseInt($('#I_impact').val(), 10) || 0;
                var aImpact = parseInt($('#A_impact').val(), 10) || 0;
                var total = owaspRiskScore * (cImpact + iImpact + aImpact);
                $('#Risk_Score').val(total);
            });
        });
    </script>
{%endblock%}