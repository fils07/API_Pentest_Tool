from django.db import models
from collectionmanagement.models import Endpoint
from django.core.exceptions import ValidationError
from .utils import *
import json

class ApiRequestField(models.Field):
    description = "A field to store API request details"
    
    def __init__(self, *args, **kwargs):
        kwargs['max_length'] = 2048  # or any appropriate length
        super().__init__(*args, **kwargs)
    
    def deconstruct(self):
        name, path, args, kwargs = super().deconstruct()
        kwargs.pop('max_length', None)
        return name, path, args, kwargs
    
    def from_db_value(self, value, expression, connection):
        if value is None:
            return value
        data = json.loads(value)
        return ApiRequest(
            url=data.get('url'),
            method=data.get('method'),
            headers=data.get('headers'),
            body=data.get('body')
        )
    
    def to_python(self, value):
        if isinstance(value, ApiRequest):
            return value
        if value is None:
            return value
        data = json.loads(value)
        return ApiRequest(
            url=data.get('url'),
            method=data.get('method'),
            headers=data.get('headers'),
            body=data.get('body')
        )
    
    def get_prep_value(self, value):
        if value is None:
            return value
        return json.dumps({
            'url': value.url,
            'method': value.method,
            'headers': value.headers,
            'body': value.body
        })
        
class Vulnerability(models.Model):
    Name = models.CharField(max_length=100)
    Description = models.TextField()
    Exploitability = models.IntegerField()
    Prevalence = models.IntegerField()
    WeaknessDetect = models.IntegerField()
    TechnicalImpact = models.IntegerField()
    
    @property
    def riskScore(self):
       return self.Exploitability + self.Prevalence + self.WeaknessDetect + self.TechnicalImpact
    
    def __str__(self) -> str:
        return self.Name

# Point de contrôle de sécurité
'''
 Chaque point de contrôle de sécurité est défini par son nom(P1), sa description, la vulnérabilité associée
Checkpoint(id,name,description,vulnerability,tools,step)
'''
class SecurityCheckpoint(models.Model):
    Name = models.CharField(max_length=100)
    Description = models.TextField()
    Vulnerability = models.ForeignKey(Vulnerability, on_delete=models.CASCADE)
    Steps = models.TextField()
    
    def __str__(self) -> str:
        return self.Name
# Scan 
'''
 A chaque scan, on associe à un endpoint la réponse(YES,NO,NOT) par rapport à un checkpoint
 Plus tard l'auditeur pourra remplir les impacts, ce sera subjectif selon chaque expert
 Colonnes de la table scan :
    - Id
    - Nom du scan
    - id du endpoint
    - id du security checkpoint
    - La requête de base
    - La réponse
    - La requête modifiée
    - La réponse à la requête modifiée
'''
class Scan(models.Model):
    STATUS = (
        ('YES', 'Yes'),
        ('NO', 'No'),
        ('NOT', 'Not'),
    )
    CID = (
        (1, 1),
        (2,2),
        (3,3),
    )
    Name = models.CharField(max_length=100)
    Endpoint = models.ForeignKey(Endpoint,on_delete=models.CASCADE)
    SecurityCheckpoint = models.ForeignKey(SecurityCheckpoint,on_delete=models.CASCADE)
    BaseRequest = ApiRequestField()
    BaseResponse = models.TextField(blank=True)
    #BaseStatus = models.TextField(blank=True)
    ModifiedRequest = ApiRequestField()
    ModifiedResponse = models.TextField(blank=True)
    #ModifiedStatus=models.TextField(blank=True)
    Status = models.CharField(max_length=3,choices=STATUS)
    ImpactConfidentiality = models.IntegerField(choices=CID,blank=True,null=True)
    ImpactIntegrity = models.IntegerField(choices=CID,blank=True,null=True)
    ImpactAvailability = models.IntegerField(choices=CID,blank=True,null=True)
    
    def __str__(self):
        return f"{self.Name}-{self.Endpoint}-{self.SecurityCheckpoint}"

    @property
    def impactScore(self):
        if(self.ImpactAvailability!=None and self.ImpactConfidentiality!=None and self.ImpactIntegrity!=None):
            return (self.ImpactAvailability+self.ImpactConfidentiality+self.ImpactIntegrity)*self.SecurityCheckpoint.Vulnerability.riskScore