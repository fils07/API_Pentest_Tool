{% extends "collectionmanagement/base.html" %}
{%load static%}
{%block content%}
<h1>Result of scan : {{scanName}}</h1>
<h2>On API collection : {{apiCollectionName}}</h2>

<div class="overflow-auto mb-3" style="max-height: 400px;">
    <table class="table table-bordered table-light border-primary">
        <thead style="color: black;background-color: rgba(210,215,217);font-weight: bold;">
            <tr>
                <th scope="col"></th>
                <th scope="col">YES</th>
                <th scope="col">NO</th>
                <th scope="col">NOT</th>
                <th scope="col">RATIO</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody> 
        {%for endpoint in checkedEndpoints%}
            <tr>
                <td>{{endpoint.name}}</td>
                {%for endpoint_id, status_counts in statusByEndpoint.items %}
                     {%if endpoint.id  == endpoint_id %}
                        <td>{{status_counts.0}}</td>
                        <td>{{status_counts.1}}</td>
                        <td>{{status_counts.2}}</td>
                        <td>{{status_counts.3}}%</td>
                      {%endif%}
                {%endfor%}
                <td><a target="_blank" href="{%url 'detailResult' scanName endpoint.id%}" style="width: auto;"><img src="{%static 'images/see_more.png'%}" width="512px"/></a> <a href="#"><img src="{%static 'images/written-paper.png'%}"/></a></td>
            </tr>
        {%endfor%}
        </tbody>
    </table>
</div>

<div class="row">
   <div class="col-md-6">
        <div class="m-auto" style="width:350px;">
            <canvas id="pieChart"></canvas>
        </div>
   </div>

   <div class="col-md-6">
       <div class="m-auto">
         <canvas id="histChart" width="650px" height="550px"></canvas>
       </div>
   </div>
</div>

<div class="row mt-5">
  <canvas id="radarChart" width="750px" class="m-auto" height="250px"></canvas>
</div>
  
<div class="row mt-5">
      <canvas id="riskChart" width="2000px" class="m-auto" height="850px"></canvas>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const statusByCheckpoint = {{statutsGlobal|safe}}
const pieData = {
  labels: [
    'YES',
    'NO',
    'NOT'
  ],
  datasets: [{
    label: 'Global Sum of YES,NO,NOT',
    data: [statusByCheckpoint['YES'], statusByCheckpoint['NO'], statusByCheckpoint['NOT']],
    backgroundColor: [
      'rgb(14, 209, 69)',
      'rgb(209, 14, 14)',
      'rgb(209, 108, 14)'
    ],
    hoverOffset: 4
  }]
};  
    
    const ctx = document.getElementById('pieChart').getContext('2d');
    
    new Chart(ctx, {
      type: 'pie',
      data: pieData,
    });
</script>

<script>
   const yesCheckpoint = {{yesByCheckpoint|safe}};
   const noCheckpoint = {{noByCheckpoint|safe}};
   const notCheckpoint = {{notByCheckpoint|safe}};
   const temp =  [...new Set(Object.keys(yesCheckpoint).concat(Object.keys(noCheckpoint)))];
   const labels = [... new Set(temp.concat(Object.keys(notCheckpoint)))];
   labels.sort((a, b) => {
  const numA = parseInt(a.substring(1), 10);
  const numB = parseInt(b.substring(1), 10);
  return numA - numB;
  });
  function generateData(dataDict) {
  const dataArray = labels.map(label => dataDict[label] || 0);
  return dataArray;
  }


const config = {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Number of endpoints which respect the security checkpoint',
        data: generateData(yesCheckpoint),
        backgroundColor: 'rgb(14, 209, 69)',
        borderColor: 'rgb(14, 209, 69)',
      },
      {
        label: 'The number of endpoint which not respect the checkpoint',
        data: generateData(noCheckpoint),
        backgroundColor: 'rgb(209, 14, 14)',
        borderColor: 'rgb(209, 14, 14)',
      },
      {
        label: 'The number of endpoint which for which the checkpoint is not applicable',
        data: generateData(notCheckpoint),
        backgroundColor: 'rgb(209, 108, 14)',
        borderColor: 'rgb(209, 108, 14)',
      },
    ]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize:1
        }
      },
      x:{
        ticks:{
          autoSkip:false,
          maxRotation:90,
          minRotation:90,
        },
      }

    }
  }
};

const hchart = document.getElementById('histChart').getContext('2d');
new Chart(hchart, config);
</script>

<script>
  const rchart = document.getElementById('radarChart').getContext('2d');
  const endpoints = {{EndpointsName|safe}};
  const ratiosByEndpoint = {{ratios|safe}}
  const rConfig = {
    type : 'radar',
    data:{
      labels:endpoints,
      datasets: [
        {
          label:'Maturité cible',
          data:Array.from({ length: endpoints.length }, () =>0.6 + Math.random() * (1 - 0.6)),
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1,
          fill:true,
        },
        {
          label:'Maturité réelle',
          data:ratiosByEndpoint,
          backgroundColor: 'rgba(153, 102, 255, 0.2)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1,
          fill:true
        }
      ]
    },
    options: {
      scales: {
    r: {
      pointLabels: {
        font: {
          size: 25
        }
      }
    }
  },
    elements: {
      line: {
        borderWidth: 3
      }
    }
   }
  }
  const radarChart = new Chart(rchart,rConfig);

</script>

<script>
  function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
 }
  riskCheckpoints={{riskByCheckpoints|safe}};
  //console.log(riskCheckpoints);
  const riskChart=document.getElementById('riskChart').getContext('2d');
  
  const datasets = Object.entries(riskCheckpoints).map(([label, values]) => ({
  label,
  data: values,
  backgroundColor:getRandomColor(),
  borderWidth: 1,
  barThickness: 6
  }));
  const riskConfig={
    type:'bar',
    data:{
      labels:labels,
      datasets:datasets
    },
    options: {
    scales: {
      y: {
        beginAtZero: true
      },
      x:{
        beginAtZero:true,
        ticks:{
          autoSkip:true,
          fontSize:3
        },
      }
    }
    }
  }
  const myriskChart=new Chart(riskChart,riskConfig)
</script>
{%endblock%}