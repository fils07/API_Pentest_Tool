{% extends "collectionmanagement/base.html" %}
{%load static%}
{%block content%}
<h1>Result of scan : {{scanName}}</h1>
<h2>On API collection : {{apiCollection.name}}</h2>

<div class="overflow-auto mb-3" style="max-height: 400px;">
    <table class="table table-bordered table-light border-primary">
        <thead style="color: black;background-color: rgba(210,215,217);font-weight: bold;">
            <tr>
                <th scope="col"></th>
                <th scope="col">YES</th>
                <th scope="col">NO</th>
                <th scope="col">NOT</th>
                <th scope="col">RATIO</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody> 
        {%for endpoint in checkedEndpoints%}
            <tr>
                <td>{{endpoint.name}}</td>
                {%for endpoint_id, status_counts in statusByEndpoint.items %}
                     {%if endpoint.id  == endpoint_id %}
                        <td>{{status_counts.0}}</td>
                        <td>{{status_counts.1}}</td>
                        <td>{{status_counts.2}}</td>
                        <td>{{status_counts.3}}%</td>
                      {%endif%}
                {%endfor%}
                <td><a target="_blank" href="{%url 'detailResult' scanName endpoint.id%}" style="width: auto;"><img src="{%static 'images/see_more.png'%}" width="512px"/></a> <a href="#"><img src="{%static 'images/written-paper.png'%}"/></a></td>
            </tr>
        {%endfor%}
        </tbody>
    </table>
</div>

<div class="row">
   <div class="col-md-6">
        <div class="m-auto" style="width:350px;">
            <canvas id="pieChart"></canvas>
        </div>
   </div>

   <div class="col-md-6">
       <div class="m-auto">
         <canvas id="histChart" width="800" height="400"></canvas>
       </div>
   </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const statusByCheckpoint = {{statutsGlobal|safe}}
const pieData = {
  labels: [
    'YES',
    'NO',
    'NOT'
  ],
  datasets: [{
    label: 'Global Sum of YES,NO,NOT',
    data: [statusByCheckpoint['YES'], statusByCheckpoint['NO'], statusByCheckpoint['NOT']],
    backgroundColor: [
      'rgb(14, 209, 69)',
      'rgb(209, 14, 14)',
      'rgb(209, 108, 14)'
    ],
    hoverOffset: 4
  }]
};  
    
    const ctx = document.getElementById('pieChart');
    
    new Chart(ctx, {
      type: 'pie',
      data: pieData,
    });
</script>

<script>
   const yesCheckpoint = {{yesByCheckpoint|safe}};
   const noCheckpoint = {{noByCheckpoint|safe}};
   const notCheckpoint = {{notByCheckpoint|safe}};
   const temp =  [...new Set(Object.keys(yesCheckpoint).concat(Object.keys(noCheckpoint)))];
   const labels = [... new Set(temp.concat(Object.keys(notCheckpoint)))];
   labels.sort((a, b) => {
  const numA = parseInt(a.substring(1), 10);
  const numB = parseInt(b.substring(1), 10);
  return numA - numB;
  });


const config = {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Number of endpoints which respect the security checkpoint',
        data: Object.values(yesCheckpoint),
        backgroundColor: 'rgb(14, 209, 69)',
        borderColor: 'rgb(14, 209, 69)',
        borderWidth: 1
      },
      {
        label: 'The number of endpoint which not respect the checkpoint',
        data: Object.values(noCheckpoint),
        backgroundColor: 'rgb(209, 14, 14)',
        borderColor: 'rgb(209, 14, 14)',
        borderWidth: 1
      },
      {
        label: 'The number of endpoint which not applicable',
        data: Object.values(notCheckpoint),
        backgroundColor: 'rgb(209, 108, 14)',
        borderColor: 'rgb(209, 108, 14)',
        borderWidth: 1
      }
    ]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize:1
        }
      }
    }
  }
};

const hchart = document.getElementById('histChart').getContext('2d');
new Chart(hchart, config);
</script>

{%endblock%}